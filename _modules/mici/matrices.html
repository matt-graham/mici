<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mici.matrices &mdash; Mici 0.2.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/mici-logo-rectangular.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mici.html">mici package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Mici</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mici.matrices</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mici.matrices</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Structured matrix classes implementing basic linear algebra operations.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">nla</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="k">as</span> <span class="nn">sla</span>

<span class="kn">from</span> <span class="nn">mici.errors</span> <span class="kn">import</span> <span class="n">LinAlgError</span>
<span class="kn">from</span> <span class="nn">mici.utils</span> <span class="kn">import</span> <span class="n">hash_array</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

    <span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">NDArray</span>

    <span class="kn">from</span> <span class="nn">mici.types</span> <span class="kn">import</span> <span class="n">MatrixLike</span><span class="p">,</span> <span class="n">ScalarLike</span>


<span class="k">def</span> <span class="nf">_choose_matrix_product_class</span><span class="p">(</span><span class="n">matrix_l</span><span class="p">:</span> <span class="n">Matrix</span><span class="p">,</span> <span class="n">matrix_r</span><span class="p">:</span> <span class="n">Matrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MatrixProduct</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">matrix_l</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">matrix_l</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">matrix_r</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">matrix_l</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrix_l</span><span class="p">,</span> <span class="n">InvertibleMatrix</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">matrix_r</span><span class="p">,</span> <span class="n">InvertibleMatrix</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">InvertibleMatrixProduct</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SquareMatrixProduct</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MatrixProduct</span>


<span class="k">def</span> <span class="nf">_is_scalar</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;__array__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="p">)</span>


<div class="viewcode-block" id="Matrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.Matrix">[docs]</a><span class="k">class</span> <span class="nc">Matrix</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for matrix-like objects.</span>

<span class="sd">    Implements overloads of the matrix multiplication operator `@`, as well as</span>
<span class="sd">    the standard multiplication and division operators `*` and `/` when the</span>
<span class="sd">    second argument is a scalar quantity.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__array_priority__</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">           shape: Shape of matrix `(num_rows, num_columns)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transpose</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">v</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">writeable</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">__array__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_is_scalar</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Scalar multiplication by zero not implemented.&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar_multiply</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_is_scalar</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Scalar division by zero not implemented.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar_multiply</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar_multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__matmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">MatrixLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Matrix</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Inconsistent dimensions for matrix multiplication: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">):</span>
            <span class="n">matrix_product_class</span> <span class="o">=</span> <span class="n">_choose_matrix_product_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">matrix_product_class</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">),</span> <span class="n">check_shapes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left_matrix_multiply</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__rmatmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">MatrixLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Matrix</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Inconsistent dimensions for matrix multiplication: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">):</span>
            <span class="n">matrix_product_class</span> <span class="o">=</span> <span class="n">_choose_matrix_product_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">matrix_product_class</span><span class="p">((</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">),</span> <span class="n">check_shapes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_right_matrix_multiply</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shape of matrix as a tuple `(num_rows, num_columns)`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Full dense representation of matrix as a 2D array.&quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Left multiply argument by the represented matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            other (array): Argument to left-multiply.</span>

<span class="sd">        Returns:</span>
<span class="sd">            result (array): Result of left-multiplying `other` by the</span>
<span class="sd">                represented matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Right multiply argument by the represented matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            other: Argument to right-multiply.</span>

<span class="sd">        Returns:</span>
<span class="sd">            result: Result of right-multiplying `other` by the represented matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate result of multiplying represented matrix by a scalar.</span>

<span class="sd">        Args:</span>
<span class="sd">            scalar: Scalar argument to multiply by.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result of multiplying represented matrix by `scalar` as another `Matrix`</span>
<span class="sd">            object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transpose of matrix.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transpose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transpose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_transpose</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transpose</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">transpose</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct transpose of matrix.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">diagonal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Diagonal of matrix as a 1D array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(shape=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute hash value for matrix object.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_hash</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Matrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for equality with another instance of the same class.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Matrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">other</span> <span class="ow">is</span> <span class="bp">self</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_equality</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ExplicitArrayMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.ExplicitArrayMatrix">[docs]</a><span class="k">class</span> <span class="nc">ExplicitArrayMatrix</span><span class="p">(</span><span class="n">Matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix with an explicit array representation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;_array&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;_array must be specified in kwargs&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_array&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray_chkfinite</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_array&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LinAlgError</span><span class="p">(</span><span class="s2">&quot;Array is not finite.&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span> <span class="o">@</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">other</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hash_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Matrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">array</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImplicitArrayMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.ImplicitArrayMatrix">[docs]</a><span class="k">class</span> <span class="nc">ImplicitArrayMatrix</span><span class="p">(</span><span class="n">Matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix with an implicit array representation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">           shape: Shape of matrix `(num_rows, num_columns)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_array</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Full dense representation of matrix as a 2D array.</span>

<span class="sd">        Generally accessing this property should be avoided wherever possible</span>
<span class="sd">        as the resulting array object may use a lot of memory and operations</span>
<span class="sd">        with it will not be able to exploit any structure in the matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_array</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct full dense representation of matrix as a 2D array.</span>

<span class="sd">        Generally calling this method should be avoided wherever possible as</span>
<span class="sd">        the returned array object may use a lot of memory and operations with</span>
<span class="sd">        it will not be able to exploit any structure in the matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="MatrixProduct"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.MatrixProduct">[docs]</a><span class="k">class</span> <span class="nc">MatrixProduct</span><span class="p">(</span><span class="n">ImplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix implicitly defined as a product of a sequence of matrices.</span>

<span class="sd">    Each adjacent pair of matrices in the sequence must have compatible shapes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrices</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Matrix</span><span class="p">],</span> <span class="n">check_shapes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            matrices: Sequence of matrices forming product in left-to-right order.</span>
<span class="sd">            check_shapes: Whether to check if all successive pairs of he matrix sequence</span>
<span class="sd">                have compatible shapes, i.e. equal inner dimensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_matrices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">matrices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_shapes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">matrix_l</span><span class="p">,</span> <span class="n">matrix_r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">matrices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">matrices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="k">if</span> <span class="n">matrix_l</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">matrix_r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Matrices </span><span class="si">{</span><span class="n">matrix_l</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">matrix_r</span><span class="si">}</span><span class="s2"> have inconsistent&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; inner dimensions for forming a matrix product.&quot;</span>
                    <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_matrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Matrix</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matrices</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MatrixProduct</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)((</span><span class="n">ScaledIdentityMatrix</span><span class="p">(</span><span class="n">scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">@</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="p">:</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">other</span> <span class="o">@</span> <span class="n">matrix</span>
        <span class="k">return</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MatrixProduct</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="o">@</span> <span class="n">MatrixProduct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">matrix</span> <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">MatrixProduct</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">matrices</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">matrix_s</span> <span class="o">==</span> <span class="n">matrix_o</span>
            <span class="k">for</span> <span class="n">matrix_s</span><span class="p">,</span> <span class="n">matrix_o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">matrices</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SquareMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.SquareMatrix">[docs]</a><span class="k">class</span> <span class="nc">SquareMatrix</span><span class="p">(</span><span class="n">Matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for matrices with equal numbers of rows and columns.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2"> is not a valid shape for a square matrix.&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Logarithm of absolute value of determinant of matrix.</span>

<span class="sd">        For matrix representations of metrics it is proportional to the logarithm of the</span>
<span class="sd">        density of then Riemannian measure associated with metric with respect to the</span>
<span class="sd">        Lebesgue measure.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="SquareMatrixProduct"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.SquareMatrixProduct">[docs]</a><span class="k">class</span> <span class="nc">SquareMatrixProduct</span><span class="p">(</span><span class="n">MatrixProduct</span><span class="p">,</span> <span class="n">SquareMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix implicitly defined as a product of a sequence of square matrices.</span>

<span class="sd">    All the matrices must have the same shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrices</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Matrix</span><span class="p">],</span> <span class="n">check_shapes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">matrices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">matrices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_shapes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">matrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">matrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">matrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not square.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">matrices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">matrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">matrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">matrix</span><span class="si">}</span><span class="s2"> have different shapes.&quot;</span>
                    <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">matrices</span><span class="p">,</span> <span class="n">check_shapes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">log_abs_det</span> <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="p">)</span></div>


<div class="viewcode-block" id="InvertibleMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.InvertibleMatrix">[docs]</a><span class="k">class</span> <span class="nc">InvertibleMatrix</span><span class="p">(</span><span class="n">SquareMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for non-singular square matrices.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inv</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SquareMatrix</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inverse of matrix as a `Matrix` object.</span>

<span class="sd">        This will not necessarily form an explicit representation of the inverse matrix</span>
<span class="sd">        but may instead return a `Matrix` object that implements the matrix</span>
<span class="sd">        multiplication operators by solving the linear system defined by the original</span>
<span class="sd">        matrix object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_inv</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SquareMatrix</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct inverse of matrix as a `Matrix` object.</span>

<span class="sd">        This will not necessarily form an explicit representation of the inverse matrix</span>
<span class="sd">        but may instead return a `Matrix` object that implements the matrix</span>
<span class="sd">        multiplication operators by solving the linear system defined by the original</span>
<span class="sd">        matrix object.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="InvertibleMatrixProduct"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.InvertibleMatrixProduct">[docs]</a><span class="k">class</span> <span class="nc">InvertibleMatrixProduct</span><span class="p">(</span><span class="n">SquareMatrixProduct</span><span class="p">,</span> <span class="n">InvertibleMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix defined as a product of a sequence of invertible matrices.</span>

<span class="sd">    All the matrices must have the same shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrices</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">InvertibleMatrix</span><span class="p">],</span> <span class="n">check_shapes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">matrices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">matrices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">matrices</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">InvertibleMatrix</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;matrix </span><span class="si">{</span><span class="n">matrix</span><span class="si">}</span><span class="s2"> is not invertible.&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">matrices</span><span class="p">,</span> <span class="n">check_shapes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InvertibleMatrixProduct</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">InvertibleMatrixProduct</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">inv</span> <span class="k">for</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrices</span><span class="p">))</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SymmetricMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.SymmetricMatrix">[docs]</a><span class="k">class</span> <span class="nc">SymmetricMatrix</span><span class="p">(</span><span class="n">SquareMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for square matrices which are equal to their transpose.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigvec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_eigendecomposition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigval</span><span class="p">,</span> <span class="n">eigvec</span> <span class="o">=</span> <span class="n">nla</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigvec</span> <span class="o">=</span> <span class="n">OrthogonalMatrix</span><span class="p">(</span><span class="n">eigvec</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Eigenvalues of matrix as a 1D array.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigvec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_eigendecomposition</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigval</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigvec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrthogonalMatrix</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Eigenvectors of matrix stacked as columns of a `Matrix` object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigvec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_eigendecomposition</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigvec</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SymmetricMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigval</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="PositiveDefiniteMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.PositiveDefiniteMatrix">[docs]</a><span class="k">class</span> <span class="nc">PositiveDefiniteMatrix</span><span class="p">(</span><span class="n">SymmetricMatrix</span><span class="p">,</span> <span class="n">InvertibleMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for positive definite matrices.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sqrt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Square-root of matrix satisfying `matrix == sqrt @ sqrt.T`.</span>

<span class="sd">        This will in general not correspond to the unique, if defined, symmetric square</span>
<span class="sd">        root of a symmetric matrix but instead may return any matrix satisfying the</span>
<span class="sd">        above property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqrt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sqrt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_sqrt</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqrt</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_construct_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct qquare-root of matrix satisfying `matrix == sqrt @ sqrt.T`.</span>

<span class="sd">        This will in general not correspond to the unique, if defined,</span>
<span class="sd">        symmetric square root of a symmetric matrix but instead may return any</span>
<span class="sd">        matrix satisfying the above property.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="IdentityMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.IdentityMatrix">[docs]</a><span class="k">class</span> <span class="nc">IdentityMatrix</span><span class="p">(</span><span class="n">PositiveDefiniteMatrix</span><span class="p">,</span> <span class="n">ImplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix representing identity operator on a vector space.</span>

<span class="sd">    Array representation has ones on diagonal elements and zeros elsewhere.</span>
<span class="sd">    May be defined with an implicit shape represented by `(None, None)` which</span>
<span class="sd">    will allow use for subset of operations where shape is not required to be</span>
<span class="sd">    known.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            size: Number of rows / columns in matrix or `None` if matrix is to be</span>
<span class="sd">                implicitly shaped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Matrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scalar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PositiveScaledIdentityMatrix</span><span class="p">(</span><span class="n">scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ScaledIdentityMatrix</span><span class="p">(</span><span class="n">scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">other</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span>

    <span class="k">def</span> <span class="nf">_construct_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentityMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigvec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentityMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentityMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">diagonal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot get array representation for identity matrix with &quot;</span>
                <span class="s2">&quot;implicit size.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Matrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span></div>


<div class="viewcode-block" id="DifferentiableMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DifferentiableMatrix">[docs]</a><span class="k">class</span> <span class="nc">DifferentiableMatrix</span><span class="p">(</span><span class="n">InvertibleMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameterically defined matrix defining gradient of scalar operations.</span>

<span class="sd">    Parameterically-defined here means the matrix is constructed as a function</span>
<span class="sd">    of one or more parameters, with the convention that the parameters</span>
<span class="sd">    correspond to **the first parameter in the `__init__` method of the</span>
<span class="sd">    `DifferentiableMatrix` subclass**, with multiple parameters wrapped in to</span>
<span class="sd">    for example a tuple, dict or list.</span>

<span class="sd">    The gradient is defined for the scalar functions of the matrix parameters</span>
<span class="sd">    implemented by the method `log_abs_det`, corresponding to</span>

<span class="sd">        f(params) = log(abs(det(matrix(params))))</span>

<span class="sd">    and by the quadratic form `vector @ matrix(params).inv @ vector`.</span>

<span class="sd">    In both cases the gradients are with respect to the parameter(s). The</span>
<span class="sd">    returned gradients will have the same structure as the first parameter of</span>
<span class="sd">    the `__init__` method of the relevant `DifferentiableMatrix` subclass,</span>
<span class="sd">    for example if the first parameter is a tuple or dict of arrays then the</span>
<span class="sd">    returned gradients will be respectively a tuple or dict of arrays of the</span>
<span class="sd">    same shapes and with the same indices / keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">grad_log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gradient of logarithm of absolute value of determinant of matrix.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DifferentiableMatrix.grad_quadratic_form_inv"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DifferentiableMatrix.grad_quadratic_form_inv">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">grad_quadratic_form_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gradient of quadratic form `vector @ matrix.inv @ vector`.</span>

<span class="sd">        Args:</span>
<span class="sd">            vector: 1D array representing vector to evaluate quadratic form at.</span>
<span class="sd">        &quot;&quot;&quot;</span></div></div>


<div class="viewcode-block" id="ScaledIdentityMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.ScaledIdentityMatrix">[docs]</a><span class="k">class</span> <span class="nc">ScaledIdentityMatrix</span><span class="p">(</span><span class="n">SymmetricMatrix</span><span class="p">,</span> <span class="n">DifferentiableMatrix</span><span class="p">,</span> <span class="n">ImplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix representing scalar multiplication operation on a vector space.</span>

<span class="sd">    Array representation has common scalar on diagonal elements and zeros</span>
<span class="sd">    elsewhere. May be defined with an implicit shape reprsented by</span>
<span class="sd">    `(None, None)` which will allow use for subset of operations where shape</span>
<span class="sd">    is not required to be known.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scalar: Scalar multiplier for identity matrix.</span>
<span class="sd">            size: Number of rows / columns in matrix. If `None` the matrix will be</span>
<span class="sd">                implicitly-shaped and only the subset of operations which do not rely on</span>
<span class="sd">                an explicit shape will be available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">scalar</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;scalar must be non-zero&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">=</span> <span class="n">scalar</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scalar multiplier.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScaledIdentityMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ScaledIdentityMatrix</span><span class="p">(</span><span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">*</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">*</span> <span class="n">other</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigvec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentityMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IdentityMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScaledIdentityMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ScaledIdentityMatrix</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">diagonal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot get array representation for scaled identity matrix &quot;</span>
                <span class="s2">&quot;with implicit size.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot get log determinant for scaled identity matrix with &quot;</span>
                <span class="s2">&quot;implicit size.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grad_log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span>

<div class="viewcode-block" id="ScaledIdentityMatrix.grad_quadratic_form_inv"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.ScaledIdentityMatrix.grad_quadratic_form_inv">[docs]</a>    <span class="k">def</span> <span class="nf">grad_quadratic_form_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vector</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="o">**</span><span class="mi">2</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(shape=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, scalar=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">ScaledIdentityMatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">scalar</span></div>


<div class="viewcode-block" id="PositiveScaledIdentityMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.PositiveScaledIdentityMatrix">[docs]</a><span class="k">class</span> <span class="nc">PositiveScaledIdentityMatrix</span><span class="p">(</span><span class="n">ScaledIdentityMatrix</span><span class="p">,</span> <span class="n">PositiveDefiniteMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Specialisation of `ScaledIdentityMatrix` with positive scalar parameter.</span>

<span class="sd">    Restricts the `scalar` parameter to be strictly positive.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scalar</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scalar multiplier must be positive.&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">scalar</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScaledIdentityMatrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scalar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PositiveScaledIdentityMatrix</span><span class="p">(</span><span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_scalar_multiply</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PositiveScaledIdentityMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PositiveScaledIdentityMatrix</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_construct_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PositiveScaledIdentityMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PositiveScaledIdentityMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="DiagonalMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DiagonalMatrix">[docs]</a><span class="k">class</span> <span class="nc">DiagonalMatrix</span><span class="p">(</span><span class="n">SymmetricMatrix</span><span class="p">,</span> <span class="n">DifferentiableMatrix</span><span class="p">,</span> <span class="n">ImplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix with non-zero elements only along its diagonal.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diagonal</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            diagonal: 1D array specifying diagonal elements of matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">diagonal</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Specified diagonal must be a 1D array.&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">((</span><span class="n">diagonal</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">_diagonal</span><span class="o">=</span><span class="n">diagonal</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">diagonal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagonal</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DiagonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DiagonalMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span> <span class="o">*</span> <span class="n">scalar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span> <span class="o">*</span> <span class="n">other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Left matrix multiplication only defined for one or two &quot;</span>
                <span class="s2">&quot;dimensional right hand sides.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span> <span class="o">*</span> <span class="n">other</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigvec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentityMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">IdentityMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DiagonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DiagonalMatrix</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grad_log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span>

<div class="viewcode-block" id="DiagonalMatrix.grad_quadratic_form_inv"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DiagonalMatrix.grad_quadratic_form_inv">[docs]</a>    <span class="k">def</span> <span class="nf">grad_quadratic_form_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="n">vector</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hash_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">DiagonalMatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">diagonal</span><span class="p">)</span></div>


<div class="viewcode-block" id="PositiveDiagonalMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.PositiveDiagonalMatrix">[docs]</a><span class="k">class</span> <span class="nc">PositiveDiagonalMatrix</span><span class="p">(</span><span class="n">DiagonalMatrix</span><span class="p">,</span> <span class="n">PositiveDefiniteMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Specialisation of `DiagonalMatrix` with positive diagonal parameter.</span>

<span class="sd">    Restricts all values in `diagonal` array parameter to be strictly positive.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diagonal</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">diagonal</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Diagonal values must all be positive.&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">diagonal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DiagonalMatrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scalar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PositiveDiagonalMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span> <span class="o">*</span> <span class="n">scalar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_scalar_multiply</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PositiveDiagonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PositiveDiagonalMatrix</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PositiveDiagonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PositiveDiagonalMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_make_array_triangular</span><span class="p">(</span><span class="n">array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make array lower/upper triangular by zeroing above/below diagonal.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="k">if</span> <span class="n">lower</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>


<div class="viewcode-block" id="TriangularMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.TriangularMatrix">[docs]</a><span class="k">class</span> <span class="nc">TriangularMatrix</span><span class="p">(</span><span class="n">InvertibleMatrix</span><span class="p">,</span> <span class="n">ExplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix with non-zero values only in lower or upper triangle elements.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">make_triangular</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            array: 2D array containing lower / upper triangular element values of</span>
<span class="sd">                matrix. Any values above (below) diagonal are ignored for lower (upper)</span>
<span class="sd">                triangular matrices i.e. when `lower == True` (`lower == False`).</span>
<span class="sd">            lower: Whether the matrix is lower-triangular (`True`) or upper-triangular</span>
<span class="sd">                (`False`).</span>
<span class="sd">            make_triangular: Whether to ensure `array` is triangular by explicitly</span>
<span class="sd">                zeroing entries in upper triangle if `lower == True` and in lower</span>
<span class="sd">                triangle if `lower == False`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">_make_array_triangular</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span> <span class="k">if</span> <span class="n">make_triangular</span> <span class="k">else</span> <span class="n">array</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_array</span><span class="o">=</span><span class="n">array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lower</span> <span class="o">=</span> <span class="n">lower</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TriangularMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TriangularMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">*</span> <span class="n">scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">make_triangular</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lower</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InverseTriangularMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">InverseTriangularMatrix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">make_triangular</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TriangularMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TriangularMatrix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">make_triangular</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagonal</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(shape=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, lower=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="InverseTriangularMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.InverseTriangularMatrix">[docs]</a><span class="k">class</span> <span class="nc">InverseTriangularMatrix</span><span class="p">(</span><span class="n">InvertibleMatrix</span><span class="p">,</span> <span class="n">ImplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Triangular matrix implicitly specified by its inverse.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">inverse_array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">make_triangular</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            inverse_array: 2D containing values of *inverse* of this matrix, with the</span>
<span class="sd">                inverse of a lower (upper) triangular matrix being itself lower (upper)</span>
<span class="sd">                triangular. Any values above (below) diagonal are ignored for lower</span>
<span class="sd">                (upper) triangular matrices i.e. when `lower == True` (`lower ==</span>
<span class="sd">                False`).</span>
<span class="sd">            lower: Whether the matrix is lower-triangular (`True`) or upper-triangular</span>
<span class="sd">                (`False`).</span>
<span class="sd">            make_triangular: Whether to ensure `inverse_array` is triangular by</span>
<span class="sd">                explicitly zeroing entries in upper triangle if `lower == True` and in</span>
<span class="sd">                lower triangle if `lower == False`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inverse_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray_chkfinite</span><span class="p">(</span><span class="n">inverse_array</span><span class="p">)</span>
        <span class="n">inverse_array</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_make_array_triangular</span><span class="p">(</span><span class="n">inverse_array</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">make_triangular</span>
            <span class="k">else</span> <span class="n">inverse_array</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inverse_array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_inverse_array</span><span class="o">=</span><span class="n">inverse_array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lower</span> <span class="o">=</span> <span class="n">lower</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InverseTriangularMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">InverseTriangularMatrix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_array</span> <span class="o">/</span> <span class="n">scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">make_triangular</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sla</span><span class="o">.</span><span class="n">solve_triangular</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_array</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">check_finite</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sla</span><span class="o">.</span><span class="n">solve_triangular</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_array</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">check_finite</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lower</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TriangularMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TriangularMatrix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_array</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">make_triangular</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InverseTriangularMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">InverseTriangularMatrix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_array</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">make_triangular</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sla</span><span class="o">.</span><span class="n">solve_triangular</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_array</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span>
            <span class="n">check_finite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">diagonal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_array</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">log_abs_det</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(shape=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, lower=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hash_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inverse_array</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">InverseTriangularMatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inverse_array</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_inverse_array</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_BaseTriangularFactoredDefiniteMatrix</span><span class="p">(</span><span class="n">SymmetricMatrix</span><span class="p">,</span> <span class="n">InvertibleMatrix</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sign</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sign</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">sign</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;sign must be equal to +1 or -1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span> <span class="o">=</span> <span class="n">sign</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">TriangularMatrix</span><span class="p">,</span> <span class="n">InverseTriangularMatrix</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Triangular matrix with `matrix = sign * factor @ factor.T`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factor</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Signed binary value with `matrix = sign * factor @ factor.T`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TriangularFactoredDefiniteMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TriangularFactoredDefiniteMatrix</span><span class="p">(</span>
            <span class="n">factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sign</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">log_abs_det</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(shape=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, sign=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="si">}</span><span class="s2">)&quot;</span>


<div class="viewcode-block" id="TriangularFactoredDefiniteMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.TriangularFactoredDefiniteMatrix">[docs]</a><span class="k">class</span> <span class="nc">TriangularFactoredDefiniteMatrix</span><span class="p">(</span>
    <span class="n">_BaseTriangularFactoredDefiniteMatrix</span><span class="p">,</span> <span class="n">DifferentiableMatrix</span><span class="p">,</span> <span class="n">ImplicitArrayMatrix</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix specified as a signed self-product of a triangular factor.</span>

<span class="sd">    The matrix is assumed to have the form</span>

<span class="sd">        matrix = sign * factor @ factor.T</span>

<span class="sd">    for and upper- or lower-trinagular matrix `factor` and signed binary value `sign`</span>
<span class="sd">    (i.e. `sign == +1 or sign == -1`), with the matrix being positive definite if `sign</span>
<span class="sd">    == +1` and negative definite if `sign == -1` under the assumption that `factor` is</span>
<span class="sd">    non-singular.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">TriangularMatrix</span><span class="p">,</span> <span class="n">InverseTriangularMatrix</span><span class="p">],</span>
        <span class="n">sign</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">factor_is_lower</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            factor: The triangular factor parameterising the matrix. Defined either a</span>
<span class="sd">                2D array, in which case only the lower- or upper-triangular elements are</span>
<span class="sd">                used depending on the value of the `factor_is_lower` boolean keyword</span>
<span class="sd">                argument, or as a `TriangularMatrix` / `InverseTriangularMatrix`</span>
<span class="sd">                instance in which case `factor_is_lower` is ignored, with `factor.lower`</span>
<span class="sd">                instead determining if the factor is lower- or upper-triangular.</span>
<span class="sd">            sign: +/-1 multiplier of factor product, corresponding respectively to a</span>
<span class="sd">                strictly positive- or negative-definite matrix.</span>
<span class="sd">            factor_is_lower: Whether the array `factor` is lower- or upper-triangular.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="p">(</span><span class="n">TriangularMatrix</span><span class="p">,</span> <span class="n">InverseTriangularMatrix</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">factor_is_lower</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;For array `factor` parameter `factor_is_lower` must be &quot;</span>
                    <span class="s2">&quot;specified as a boolean value.&quot;</span>
                <span class="p">)</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">TriangularMatrix</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">factor_is_lower</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factor</span> <span class="o">=</span> <span class="n">factor</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sign</span><span class="o">=</span><span class="n">sign</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TriangularFactoredDefiniteMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TriangularFactoredDefiniteMatrix</span><span class="p">(</span>
            <span class="n">factor</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sign</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span> <span class="o">*</span> <span class="p">((</span><span class="n">other</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grad_log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">diagonal</span><span class="p">)</span>

<div class="viewcode-block" id="TriangularFactoredDefiniteMatrix.grad_quadratic_form_inv"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.TriangularFactoredDefiniteMatrix.grad_quadratic_form_inv">[docs]</a>    <span class="k">def</span> <span class="nf">grad_quadratic_form_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="n">inv_factor_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="n">vector</span>
        <span class="n">inv_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="n">vector</span>
        <span class="k">return</span> <span class="n">_make_array_triangular</span><span class="p">(</span>
            <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">inv_vector</span><span class="p">,</span> <span class="n">inv_factor_vector</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">lower</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">TriangularFactoredDefiniteMatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">sign</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">factor</span></div>


<div class="viewcode-block" id="TriangularFactoredPositiveDefiniteMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.TriangularFactoredPositiveDefiniteMatrix">[docs]</a><span class="k">class</span> <span class="nc">TriangularFactoredPositiveDefiniteMatrix</span><span class="p">(</span>
    <span class="n">TriangularFactoredDefiniteMatrix</span><span class="p">,</span> <span class="n">PositiveDefiniteMatrix</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Positive definite matrix parametrized a triangular matrix product.</span>

<span class="sd">    The matrix is assumed to have the parameterisation</span>

<span class="sd">        matrix = factor @ factor.T</span>

<span class="sd">    where `factor` is an upper- or lower-triangular matrix. Note for the case `factor`</span>
<span class="sd">    is lower-triangular this corresponds to the standard Cholesky factorisation of a</span>
<span class="sd">    positive definite matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">TriangularMatrix</span><span class="p">,</span> <span class="n">InverseTriangularMatrix</span><span class="p">],</span>
        <span class="n">factor_is_lower</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            factor: The triangular factor parameterising the matrix. Defined either a</span>
<span class="sd">                2D array, in which case only the lower- or upper-triangular elements are</span>
<span class="sd">                used depending on the value of the `factor_is_lower` boolean keyword</span>
<span class="sd">                argument, or as a `TriangularMatrix` / `InverseTriangularMatrix`</span>
<span class="sd">                instance in which case `factor_is_lower` is ignored, with `factor.lower`</span>
<span class="sd">                instead determining if the factor is lower- or upper-triangular.</span>
<span class="sd">            factor_is_lower: Whether the array `factor` is lower- or upper-triangular.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">factor_is_lower</span><span class="o">=</span><span class="n">factor_is_lower</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TriangularFactoredDefiniteMatrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scalar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TriangularFactoredPositiveDefiniteMatrix</span><span class="p">(</span>
                <span class="n">factor</span><span class="o">=</span><span class="n">scalar</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_scalar_multiply</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TriangularFactoredPositiveDefiniteMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TriangularFactoredPositiveDefiniteMatrix</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">TriangularMatrix</span><span class="p">,</span> <span class="n">InverseTriangularMatrix</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span></div>


<div class="viewcode-block" id="DenseDefiniteMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DenseDefiniteMatrix">[docs]</a><span class="k">class</span> <span class="nc">DenseDefiniteMatrix</span><span class="p">(</span>
    <span class="n">_BaseTriangularFactoredDefiniteMatrix</span><span class="p">,</span> <span class="n">DifferentiableMatrix</span><span class="p">,</span> <span class="n">ExplicitArrayMatrix</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Definite matrix specified by a dense 2D array.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">TriangularMatrix</span><span class="p">,</span> <span class="n">InverseTriangularMatrix</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_posdef</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            array : 2D array specifying matrix entries.</span>
<span class="sd">            factor: Optional argument giving the triangular factorisation of the matrix</span>
<span class="sd">                such that `matrix = factor @ factor.T` if `is_posdef=True` or `matrix =</span>
<span class="sd">                -factor @ factor.T` otherwise. If not pre-computed and specified at</span>
<span class="sd">                initialisation a factorisation will only be computed when first required</span>
<span class="sd">                by an operation which depends on the factor.</span>
<span class="sd">            is_posdef: Whether matrix (and so corresponding array representation) is</span>
<span class="sd">                positive definite, with the matrix assumed to be negative-definite if</span>
<span class="sd">                not. This is **not** checked on initialisation, and so if `array` is</span>
<span class="sd">                positive (negative) definite and `is_posdef` is `False` (`True`) then a</span>
<span class="sd">                `LinAlgError` exception will be if a later attempt is made to factorize</span>
<span class="sd">                the matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sign</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">is_posdef</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">_array</span><span class="o">=</span><span class="n">array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factor</span> <span class="o">=</span> <span class="n">factor</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DenseDefiniteMatrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scalar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sign</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">DensePositiveDefiniteMatrix</span><span class="p">(</span>
                <span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
                <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">abs</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factor</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DenseDefiniteMatrix</span><span class="p">(</span>
                <span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
                <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">abs</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factor</span><span class="p">,</span>
                <span class="n">is_posdef</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">TriangularMatrix</span><span class="p">,</span> <span class="n">InverseTriangularMatrix</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_factor</span> <span class="o">=</span> <span class="n">TriangularMatrix</span><span class="p">(</span>
                    <span class="n">nla</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="p">),</span>
                    <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">make_triangular</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">nla</span><span class="o">.</span><span class="n">LinAlgError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LinAlgError</span><span class="p">(</span><span class="s2">&quot;Cholesky factorisation failed.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factor</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grad_log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">array</span>

<div class="viewcode-block" id="DenseDefiniteMatrix.grad_quadratic_form_inv"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DenseDefiniteMatrix.grad_quadratic_form_inv">[docs]</a>    <span class="k">def</span> <span class="nf">grad_quadratic_form_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="n">inv_matrix_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="n">vector</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">inv_matrix_vector</span><span class="p">,</span> <span class="n">inv_matrix_vector</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DenseDefiniteMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DenseDefiniteMatrix</span><span class="p">(</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_construct_inv</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
            <span class="n">factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">is_posdef</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sign</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DensePositiveDefiniteMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DensePositiveDefiniteMatrix">[docs]</a><span class="k">class</span> <span class="nc">DensePositiveDefiniteMatrix</span><span class="p">(</span><span class="n">DenseDefiniteMatrix</span><span class="p">,</span> <span class="n">PositiveDefiniteMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Positive-definite matrix specified by a dense 2D array.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">TriangularMatrix</span><span class="p">,</span> <span class="n">InverseTriangularMatrix</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            array: 2D array specifying matrix entries.</span>
<span class="sd">            factor: Optional argument giving the triangular factorisation of the matrix</span>
<span class="sd">                such that `matrix = factor @ factor.T`. If not pre-computed and</span>
<span class="sd">                specified at initialisation a factorisation will only be computed when</span>
<span class="sd">                first required by an operation which depends on the factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">array</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">,</span> <span class="n">is_posdef</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DensePositiveDefiniteMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DensePositiveDefiniteMatrix</span><span class="p">(</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_construct_inv</span><span class="p">(),</span> <span class="n">factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">T</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">TriangularMatrix</span><span class="p">,</span> <span class="n">InverseTriangularMatrix</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span></div>


<div class="viewcode-block" id="DensePositiveDefiniteProductMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DensePositiveDefiniteProductMatrix">[docs]</a><span class="k">class</span> <span class="nc">DensePositiveDefiniteProductMatrix</span><span class="p">(</span><span class="n">DensePositiveDefiniteMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Positive-definite matrix specified as a signed symmetric product.</span>

<span class="sd">    The matrix is assumed to have the form</span>

<span class="sd">        matrix = rect_matrix @ pos_def_matrix @ rect_matrix.T</span>

<span class="sd">    for a dense rectangular matrix `rect_matrix` with shape `(dim_0, dim_1)` (`dim_1 &gt;</span>
<span class="sd">    dim_0`) positive definite matrix `pos_def_matrix` with shape `(dim_1, dim_1)`, with</span>
<span class="sd">    the resulting matrix being positive definite under the assumption that `rect_matrix`</span>
<span class="sd">    has full row rank.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rect_matrix</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">],</span>
        <span class="n">pos_def_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PositiveDefiniteMatrix</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            rect_matrix: Rectangular matrix of shape `(dim_0, dim_1)` with it and its</span>
<span class="sd">                transpose forming the leftmost and righmost term respectively in the</span>
<span class="sd">                symmetric matrix product defining the matrix.</span>
<span class="sd">            pos_def_matrix: Optional positive positive definite matrix with shape</span>
<span class="sd">                `(dim_inner, dim_inner)` specifying inner term in symmetric matrix</span>
<span class="sd">                product defining matrix. If `None` an identity matrix is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rect_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">rect_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rect_matrix must have more columns than rows&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rect_matrix</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">):</span>
            <span class="n">rect_matrix</span> <span class="o">=</span> <span class="n">DenseRectangularMatrix</span><span class="p">(</span><span class="n">rect_matrix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rect_matrix</span> <span class="o">=</span> <span class="n">rect_matrix</span>
        <span class="k">if</span> <span class="n">pos_def_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos_def_matrix</span> <span class="o">=</span> <span class="n">IdentityMatrix</span><span class="p">(</span><span class="n">rect_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos_def_matrix</span> <span class="o">=</span> <span class="n">pos_def_matrix</span>
        <span class="n">_array</span> <span class="o">=</span> <span class="n">rect_matrix</span> <span class="o">@</span> <span class="p">(</span><span class="n">pos_def_matrix</span> <span class="o">@</span> <span class="n">rect_matrix</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">_array</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grad_log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rect_matrix</span><span class="o">.</span><span class="n">array</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_def_matrix</span><span class="p">))</span>

<div class="viewcode-block" id="DensePositiveDefiniteProductMatrix.grad_quadratic_form_inv"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DensePositiveDefiniteProductMatrix.grad_quadratic_form_inv">[docs]</a>    <span class="k">def</span> <span class="nf">grad_quadratic_form_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="n">inv_matrix_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="n">vector</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span>
            <span class="n">inv_matrix_vector</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos_def_matrix</span> <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rect_matrix</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">inv_matrix_vector</span><span class="p">),</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="DenseSquareMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DenseSquareMatrix">[docs]</a><span class="k">class</span> <span class="nc">DenseSquareMatrix</span><span class="p">(</span><span class="n">InvertibleMatrix</span><span class="p">,</span> <span class="n">ExplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dense non-singular square matrix.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">lu_and_piv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lu_transposed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            array: 2D array specifying matrix entries.</span>
<span class="sd">            lu_and_piv: Pivoted LU factorisation represented as a tuple with first</span>
<span class="sd">                element a 2D array containing the lower and upper triangular factors</span>
<span class="sd">                (with the unit diagonal of the lower triangular factor not stored) and</span>
<span class="sd">                the second element a 1D array containing the pivot indices. Corresponds</span>
<span class="sd">                to the output of `scipy.linalg.lu_factor` and input to</span>
<span class="sd">                `scipy.linalg.lu_solve`.</span>
<span class="sd">            lu_transposed: Whether LU factorisation is of original array or its</span>
<span class="sd">                transpose.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_array</span><span class="o">=</span><span class="n">array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lu_and_piv</span> <span class="o">=</span> <span class="n">lu_and_piv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lu_transposed</span> <span class="o">=</span> <span class="n">lu_transposed</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DenseSquareMatrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lu_and_piv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lu_transposed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DenseSquareMatrix</span><span class="p">(</span><span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_lu</span><span class="p">,</span> <span class="n">piv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lu_and_piv</span>
            <span class="c1"># Multiply upper-triangle by scalar</span>
            <span class="n">new_lu</span> <span class="o">=</span> <span class="n">old_lu</span> <span class="o">+</span> <span class="p">(</span><span class="n">scalar</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">old_lu</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">DenseSquareMatrix</span><span class="p">(</span>
                <span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="p">,</span> <span class="p">(</span><span class="n">new_lu</span><span class="p">,</span> <span class="n">piv</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lu_transposed</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lu_and_piv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pivoted LU factorisation of matrix.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lu_and_piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lu_and_piv</span> <span class="o">=</span> <span class="n">sla</span><span class="o">.</span><span class="n">lu_factor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="p">,</span> <span class="n">check_finite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lu_transposed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lu_and_piv</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">lu</span><span class="p">,</span> <span class="n">piv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lu_and_piv</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lu</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DenseSquareMatrix</span><span class="p">:</span>
        <span class="n">lu_and_piv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lu_and_piv</span>
        <span class="k">return</span> <span class="n">DenseSquareMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lu_and_piv</span><span class="p">,</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lu_transposed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InverseLUFactoredSquareMatrix</span><span class="p">:</span>
        <span class="n">lu_and_piv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lu_and_piv</span>
        <span class="k">return</span> <span class="n">InverseLUFactoredSquareMatrix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_array</span><span class="p">,</span> <span class="n">lu_and_piv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lu_transposed</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="InverseLUFactoredSquareMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.InverseLUFactoredSquareMatrix">[docs]</a><span class="k">class</span> <span class="nc">InverseLUFactoredSquareMatrix</span><span class="p">(</span><span class="n">InvertibleMatrix</span><span class="p">,</span> <span class="n">ImplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Square matrix implicitly defined by LU factorisation of inverse.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inv_array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">inv_lu_and_piv</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">],</span>
        <span class="n">inv_lu_transposed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            inv_array: 2D array specifying inverse matrix entries.</span>
<span class="sd">            inv_lu_and_piv: Pivoted LU factorisation represented as a tuple with first</span>
<span class="sd">                element a 2D array containing the lower and upper triangular factors</span>
<span class="sd">                (with the unit diagonal of the lower triangular factor not stored) and</span>
<span class="sd">                the second element a 1D array containing the pivot indices. Corresponds</span>
<span class="sd">                to the output of `scipy.linalg.lu_factor` and input to</span>
<span class="sd">                `scipy.linalg.lu_solve`.</span>
<span class="sd">            inv_lu_transposed: Whether LU factorisation is of inverse of array or</span>
<span class="sd">                transpose of inverse of array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inv_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inv_array</span> <span class="o">=</span> <span class="n">inv_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_and_piv</span> <span class="o">=</span> <span class="n">inv_lu_and_piv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_transposed</span> <span class="o">=</span> <span class="n">inv_lu_transposed</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InverseLUFactoredSquareMatrix</span><span class="p">:</span>
        <span class="n">old_inv_lu</span><span class="p">,</span> <span class="n">piv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_and_piv</span>
        <span class="c1"># Divide upper-triangle by scalar</span>
        <span class="n">new_inv_lu</span> <span class="o">=</span> <span class="n">old_inv_lu</span> <span class="o">-</span> <span class="p">(</span><span class="n">scalar</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">scalar</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">old_inv_lu</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">InverseLUFactoredSquareMatrix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inv_array</span> <span class="o">/</span> <span class="n">scalar</span><span class="p">,</span> <span class="p">(</span><span class="n">new_inv_lu</span><span class="p">,</span> <span class="n">piv</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_transposed</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sla</span><span class="o">.</span><span class="n">lu_solve</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_and_piv</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_transposed</span><span class="p">,</span> <span class="n">check_finite</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sla</span><span class="o">.</span><span class="n">lu_solve</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_and_piv</span><span class="p">,</span>
            <span class="n">other</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_transposed</span><span class="p">,</span>
            <span class="n">check_finite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_and_piv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DenseSquareMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DenseSquareMatrix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inv_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_and_piv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_transposed</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InverseLUFactoredSquareMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">InverseLUFactoredSquareMatrix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inv_array</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_and_piv</span><span class="p">,</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv_lu_transposed</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hash_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inv_array</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">InverseLUFactoredSquareMatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inv_array</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_inv_array</span><span class="p">)</span></div>


<div class="viewcode-block" id="DenseSymmetricMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DenseSymmetricMatrix">[docs]</a><span class="k">class</span> <span class="nc">DenseSymmetricMatrix</span><span class="p">(</span><span class="n">SymmetricMatrix</span><span class="p">,</span> <span class="n">InvertibleMatrix</span><span class="p">,</span> <span class="n">ExplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dense non-singular symmetric matrix.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span>
        <span class="n">eigvec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">OrthogonalMatrix</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">eigval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            array: Explicit 2D array representation of matrix.</span>
<span class="sd">            eigvec: Optional. If specified either a 2D array or an `OrthogonalMatrix`</span>
<span class="sd">                instance, in both cases the columns of the matrix corresponding to the</span>
<span class="sd">                orthonormal set of eigenvectors of the matrix being constructed.</span>
<span class="sd">            eigval: Optional. If specified a 1D array containing the eigenvalues of the</span>
<span class="sd">                matrix being constructed, with `eigval[i]` the eigenvalue associated</span>
<span class="sd">                with column `i` of `eigvec`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_array</span><span class="o">=</span><span class="n">array</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eigvec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">eigvec</span> <span class="o">=</span> <span class="n">OrthogonalMatrix</span><span class="p">(</span><span class="n">eigvec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigvec</span> <span class="o">=</span> <span class="n">eigvec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigval</span> <span class="o">=</span> <span class="n">eigval</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DenseSymmetricMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DenseSymmetricMatrix</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">*</span> <span class="n">scalar</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_eigvec</span><span class="p">,</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eigval</span> <span class="o">*</span> <span class="n">scalar</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EigendecomposedSymmetricMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">EigendecomposedSymmetricMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigval</span><span class="p">)</span></div>


<div class="viewcode-block" id="OrthogonalMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.OrthogonalMatrix">[docs]</a><span class="k">class</span> <span class="nc">OrthogonalMatrix</span><span class="p">(</span><span class="n">InvertibleMatrix</span><span class="p">,</span> <span class="n">ExplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Square matrix with columns and rows that are orthogonal unit vectors.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            array: Explicit 2D array representation of matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_array</span><span class="o">=</span><span class="n">array</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScaledOrthogonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ScaledOrthogonalMatrix</span><span class="p">(</span><span class="n">scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrthogonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OrthogonalMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrthogonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="ScaledOrthogonalMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.ScaledOrthogonalMatrix">[docs]</a><span class="k">class</span> <span class="nc">ScaledOrthogonalMatrix</span><span class="p">(</span><span class="n">InvertibleMatrix</span><span class="p">,</span> <span class="n">ImplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix corresponding to orthogonal matrix multiplied by a scalar.</span>

<span class="sd">    Matrix is assumed to have the paramterisation</span>

<span class="sd">        matrix = scalar * orth_array</span>

<span class="sd">    where `scalar` is a real-valued scalar and `orth_array` is an orthogonal matrix</span>
<span class="sd">    represented as a square 2D array.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">orth_array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scalar: Scalar multiplier as a floating point value.</span>
<span class="sd">            orth_array: 2D array representation of orthogonal matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">orth_array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_orth_array</span><span class="o">=</span><span class="n">orth_array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">=</span> <span class="n">scalar</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orth_array</span> <span class="o">@</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">*</span> <span class="p">(</span><span class="n">other</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orth_array</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScaledOrthogonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ScaledOrthogonalMatrix</span><span class="p">(</span><span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orth_array</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orth_array</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">diagonal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orth_array</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScaledOrthogonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ScaledOrthogonalMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orth_array</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScaledOrthogonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ScaledOrthogonalMatrix</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orth_array</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span><span class="p">,</span> <span class="n">hash_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orth_array</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">ScaledOrthogonalMatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_scalar</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orth_array</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_orth_array</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="EigendecomposedSymmetricMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.EigendecomposedSymmetricMatrix">[docs]</a><span class="k">class</span> <span class="nc">EigendecomposedSymmetricMatrix</span><span class="p">(</span>
    <span class="n">SymmetricMatrix</span><span class="p">,</span> <span class="n">InvertibleMatrix</span><span class="p">,</span> <span class="n">ImplicitArrayMatrix</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Symmetric matrix parametrized by its eigendecomposition.</span>

<span class="sd">    The matrix is assumed to have the parameterisation</span>

<span class="sd">        matrix = eigvec @ diag(eigval) @ eigvec.T</span>

<span class="sd">    where `eigvec` is an orthogonal matrix, with columns corresponding to the</span>
<span class="sd">    eigenvectors of `matrix` and `eigval` is 1D array of the corresponding eigenvalues</span>
<span class="sd">    of `matrix`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eigvec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">OrthogonalMatrix</span><span class="p">],</span> <span class="n">eigval</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            eigvec: Either a 2D array or an `OrthogonalMatrix` instance, in both cases</span>
<span class="sd">                the columns of the matrix corresponding to the orthonormal set of</span>
<span class="sd">                eigenvectors of the matrix being constructed.</span>
<span class="sd">            eigval: A 1D array containing the eigenvalues of the matrix being</span>
<span class="sd">                constructed, with `eigval[i]` the eigenvalue associated with column `i`</span>
<span class="sd">                of `eigvec`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eigvec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">eigvec</span> <span class="o">=</span> <span class="n">OrthogonalMatrix</span><span class="p">(</span><span class="n">eigvec</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">eigvec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigvec</span> <span class="o">=</span> <span class="n">eigvec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eigval</span> <span class="o">=</span> <span class="n">eigval</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eigval</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">eigval</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diag_eigval</span> <span class="o">=</span> <span class="n">ScaledIdentityMatrix</span><span class="p">(</span><span class="n">eigval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diag_eigval</span> <span class="o">=</span> <span class="n">DiagonalMatrix</span><span class="p">(</span><span class="n">eigval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EigendecomposedSymmetricMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">EigendecomposedSymmetricMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigval</span> <span class="o">*</span> <span class="n">scalar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span> <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diag_eigval</span> <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">other</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">other</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">diag_eigval</span><span class="p">)</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EigendecomposedSymmetricMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">EigendecomposedSymmetricMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot get array representation for symmetric &quot;</span>
                <span class="s2">&quot;eigendecomposed matrix with implicit size.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="n">hash_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigval</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigval</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">eigval</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">eigvec</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="EigendecomposedPositiveDefiniteMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.EigendecomposedPositiveDefiniteMatrix">[docs]</a><span class="k">class</span> <span class="nc">EigendecomposedPositiveDefiniteMatrix</span><span class="p">(</span>
    <span class="n">EigendecomposedSymmetricMatrix</span><span class="p">,</span> <span class="n">PositiveDefiniteMatrix</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Positive definite matrix parametrized by its eigendecomposition.</span>

<span class="sd">    The matrix is assumed to have the parameterisation</span>

<span class="sd">        matrix = eigvec @ diag(eigval) @ eigvec.T</span>

<span class="sd">    where `eigvec` is an orthogonal matrix, with columns corresponding to the</span>
<span class="sd">    eigenvectors of `matrix` and `eigval` is 1D array of the corresponding strictly</span>
<span class="sd">    positive eigenvalues of `matrix`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eigvec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">OrthogonalMatrix</span><span class="p">],</span> <span class="n">eigval</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">eigval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Eigenvalues must all be positive.&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">eigvec</span><span class="p">,</span> <span class="n">eigval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scalar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EigendecomposedPositiveDefiniteMatrix</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigval</span> <span class="o">*</span> <span class="n">scalar</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_scalar_multiply</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EigendecomposedPositiveDefiniteMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">EigendecomposedPositiveDefiniteMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EigendecomposedPositiveDefiniteMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">EigendecomposedPositiveDefiniteMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigval</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="SoftAbsRegularizedPositiveDefiniteMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.SoftAbsRegularizedPositiveDefiniteMatrix">[docs]</a><span class="k">class</span> <span class="nc">SoftAbsRegularizedPositiveDefiniteMatrix</span><span class="p">(</span>
    <span class="n">EigendecomposedPositiveDefiniteMatrix</span><span class="p">,</span> <span class="n">DifferentiableMatrix</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix transformed to be positive definite by regularising eigenvalues.</span>

<span class="sd">    Matrix is parametrized by a symmetric array `symmetric_array`, of which an</span>
<span class="sd">    eigendecomposition is formed `eigvec, eigval = eigh(symmetric_array)`, with the</span>
<span class="sd">    output matrix then `matrix = eigvec @ softabs(eigval) @ eigvec.T` where `softabs` is</span>
<span class="sd">    a smooth approximation to the absolute function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetric_array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">softabs_coeff</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            symmetric_array: 2D square array with symmetric values, i.e.</span>
<span class="sd">                `symmetric_array[i, j] == symmetric_array[j, i]` for all indices `i` and</span>
<span class="sd">                `j` which represents symmetric matrix to form eigenvalue-regularized</span>
<span class="sd">                transformation of.</span>
<span class="sd">            softabs_coeff: Positive regularisation coefficient for smooth approximation</span>
<span class="sd">                to absolute value. As the value tends to infinity the approximation</span>
<span class="sd">                becomes increasingly close to the absolute function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">softabs_coeff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;softabs_coeff must be positive.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_softabs_coeff</span> <span class="o">=</span> <span class="n">softabs_coeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unreg_eigval</span><span class="p">,</span> <span class="n">eigvec</span> <span class="o">=</span> <span class="n">nla</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">symmetric_array</span><span class="p">)</span>
        <span class="n">eigval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unreg_eigval</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">eigvec</span><span class="p">,</span> <span class="n">eigval</span><span class="p">)</span>

<div class="viewcode-block" id="SoftAbsRegularizedPositiveDefiniteMatrix.softabs"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.SoftAbsRegularizedPositiveDefiniteMatrix.softabs">[docs]</a>    <span class="k">def</span> <span class="nf">softabs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Smooth approximation to absolute function.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_softabs_coeff</span><span class="p">)</span></div>

<div class="viewcode-block" id="SoftAbsRegularizedPositiveDefiniteMatrix.grad_softabs"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.SoftAbsRegularizedPositiveDefiniteMatrix.grad_softabs">[docs]</a>    <span class="k">def</span> <span class="nf">grad_softabs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Derivative of smooth approximation to absolute function.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_softabs_coeff</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_softabs_coeff</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_softabs_coeff</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grad_log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="n">grad_eigval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_softabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unreg_eigval</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigval</span>
        <span class="k">return</span> <span class="n">EigendecomposedSymmetricMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="p">,</span> <span class="n">grad_eigval</span><span class="p">)</span><span class="o">.</span><span class="n">array</span>

<div class="viewcode-block" id="SoftAbsRegularizedPositiveDefiniteMatrix.grad_quadratic_form_inv"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.SoftAbsRegularizedPositiveDefiniteMatrix.grad_quadratic_form_inv">[docs]</a>    <span class="k">def</span> <span class="nf">grad_quadratic_form_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="n">num_j_mtx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigval</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigval</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">num_j_mtx</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grad_softabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unreg_eigval</span><span class="p">))</span>
        <span class="n">den_j_mtx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unreg_eigval</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">unreg_eigval</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">den_j_mtx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">j_mtx</span> <span class="o">=</span> <span class="n">num_j_mtx</span> <span class="o">/</span> <span class="n">den_j_mtx</span>
        <span class="n">e_vct</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">vector</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigval</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span> <span class="o">@</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">e_vct</span><span class="p">,</span> <span class="n">e_vct</span><span class="p">)</span> <span class="o">*</span> <span class="n">j_mtx</span><span class="p">))</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigvec</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BlockMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.BlockMatrix">[docs]</a><span class="k">class</span> <span class="nc">BlockMatrix</span><span class="p">(</span><span class="n">ImplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix with non-zero entries defined by a series of submatrix blocks.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Matrix</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Non-zero blocks of matrix as a tuple of Matrix instances&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">block</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">BlockMatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">block_s</span> <span class="o">==</span> <span class="n">block_o</span> <span class="k">for</span> <span class="n">block_s</span><span class="p">,</span> <span class="n">block_o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SquareBlockDiagonalMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.SquareBlockDiagonalMatrix">[docs]</a><span class="k">class</span> <span class="nc">SquareBlockDiagonalMatrix</span><span class="p">(</span><span class="n">InvertibleMatrix</span><span class="p">,</span> <span class="n">BlockMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Square matrix with non-zero values only in blocks along diagonal.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">SquareMatrix</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            blocks: Sequence of square matrices defining non-zero blocks along diagonal</span>
<span class="sd">                of matrix in order left-to-right.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">SquareMatrix</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All blocks must be square&quot;</span><span class="p">)</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">((</span><span class="n">total_size</span><span class="p">,</span> <span class="n">total_size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sizes</span> <span class="o">=</span> <span class="n">sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sizes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">SquareMatrix</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Blocks containing non-zero values left-to-right along diagonal.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span>

    <span class="k">def</span> <span class="nf">_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">block</span> <span class="o">@</span> <span class="n">part</span>
                <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">part</span> <span class="o">@</span> <span class="n">block</span>
                <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SquareBlockDiagonalMatrix</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">scalar</span> <span class="o">*</span> <span class="n">block</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sla</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">array</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SquareBlockDiagonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SquareBlockDiagonalMatrix</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_construct_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SquareBlockDiagonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SquareBlockDiagonalMatrix</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">sqrt</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">diagonal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">block</span><span class="o">.</span><span class="n">diagonal</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SquareBlockDiagonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">inv</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">block</span><span class="o">.</span><span class="n">eigval</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eigvec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SquareBlockDiagonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SquareBlockDiagonalMatrix</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">eigvec</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">log_abs_det</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span></div>


<div class="viewcode-block" id="SymmetricBlockDiagonalMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.SymmetricBlockDiagonalMatrix">[docs]</a><span class="k">class</span> <span class="nc">SymmetricBlockDiagonalMatrix</span><span class="p">(</span><span class="n">SquareBlockDiagonalMatrix</span><span class="p">,</span> <span class="n">SymmetricMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Symmetric specialisation of `SquareBlockDiagonalMatrix`.</span>

<span class="sd">    All matrix blocks in diagonal are restricted to be symmetric, i.e. `block.T ==</span>
<span class="sd">    block`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">SymmetricMatrix</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            blocks: Sequence of symmetric matrices defining non-zero blocks along</span>
<span class="sd">                diagonal of matrix in order left-to-right.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">SymmetricMatrix</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All blocks must be symmetric&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SymmetricBlockDiagonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SymmetricBlockDiagonalMatrix</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">scalar</span> <span class="o">*</span> <span class="n">block</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SymmetricBlockDiagonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="PositiveDefiniteBlockDiagonalMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.PositiveDefiniteBlockDiagonalMatrix">[docs]</a><span class="k">class</span> <span class="nc">PositiveDefiniteBlockDiagonalMatrix</span><span class="p">(</span>
    <span class="n">SquareBlockDiagonalMatrix</span><span class="p">,</span> <span class="n">PositiveDefiniteMatrix</span><span class="p">,</span> <span class="n">DifferentiableMatrix</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Positive definite specialisation of `SymmetricBlockDiagonalMatrix`.</span>

<span class="sd">    All matrix blocks in diagonal are restricted to be positive definite.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">PositiveDefiniteMatrix</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            blocks: Sequence of positive-definite matrices defining non-zero blocks</span>
<span class="sd">                along diagonal of matrix in order left-to-right.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">PositiveDefiniteMatrix</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All blocks must be positive definite&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_differentiable</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">DifferentiableMatrix</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SquareBlockDiagonalMatrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scalar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PositiveDefiniteBlockDiagonalMatrix</span><span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">scalar</span> <span class="o">*</span> <span class="n">block</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_scalar_multiply</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">PositiveDefiniteBlockDiagonalMatrix</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_construct_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SquareBlockDiagonalMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SquareBlockDiagonalMatrix</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">sqrt</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grad_log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_differentiable</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">grad_log_abs_det</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not all blocks are differentiable&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PositiveDefiniteBlockDiagonalMatrix.grad_quadratic_form_inv"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.PositiveDefiniteBlockDiagonalMatrix.grad_quadratic_form_inv">[docs]</a>    <span class="k">def</span> <span class="nf">grad_quadratic_form_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_differentiable</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="n">block</span><span class="o">.</span><span class="n">grad_quadratic_form_inv</span><span class="p">(</span><span class="n">vector_part</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">vector_part</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not all blocks are differentiable&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DenseRectangularMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.DenseRectangularMatrix">[docs]</a><span class="k">class</span> <span class="nc">DenseRectangularMatrix</span><span class="p">(</span><span class="n">ExplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dense rectangular matrix.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            array: 2D array specifying matrix entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_array</span><span class="o">=</span><span class="n">array</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DenseRectangularMatrix</span><span class="p">(</span><span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DenseRectangularMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DenseRectangularMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">T</span><span class="p">)</span></div>


<div class="viewcode-block" id="BlockRowMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.BlockRowMatrix">[docs]</a><span class="k">class</span> <span class="nc">BlockRowMatrix</span><span class="p">(</span><span class="n">BlockMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix composed of horizontal concatenation of a series of blocks.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Matrix</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            blocks: Sequence of matrices defining a row of blocks in order left-to-right</span>
<span class="sd">                which when horizontally concatenated give the overall matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All blocks must be matrices&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All blocks must have same row-dimension.&quot;</span><span class="p">)</span>
        <span class="n">col_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">sum</span><span class="p">(</span><span class="n">col_dims</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">col_dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Matrix</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Blocks of matrix in left-to-right order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">block</span> <span class="o">@</span> <span class="n">part</span>
                <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">other</span> <span class="o">@</span> <span class="n">block</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BlockRowMatrix</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scalar</span> <span class="o">*</span> <span class="n">block</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">block</span><span class="o">.</span><span class="n">array</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockColumnMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BlockColumnMatrix</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">))</span></div>


<div class="viewcode-block" id="BlockColumnMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.BlockColumnMatrix">[docs]</a><span class="k">class</span> <span class="nc">BlockColumnMatrix</span><span class="p">(</span><span class="n">BlockMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix composed of vertical concatenation of a series of blocks.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Matrix</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            blocks : Sequence of matrices defining a column of blocks in order</span>
<span class="sd">                top-to-bottom which when vertically concatenated give the overall</span>
<span class="sd">                matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All blocks must be matrices&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All blocks must have same column-dimension.&quot;</span><span class="p">)</span>
        <span class="n">row_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">row_dims</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">row_dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Matrix</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Blocks of matrix in top-to-bottom order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">block</span> <span class="o">@</span> <span class="n">other</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">part</span> <span class="o">@</span> <span class="n">block</span>
                <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BlockColumnMatrix</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">scalar</span> <span class="o">*</span> <span class="n">block</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">block</span><span class="o">.</span><span class="n">array</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BlockRowMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BlockRowMatrix</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocks</span><span class="p">))</span></div>


<div class="viewcode-block" id="SquareLowRankUpdateMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.SquareLowRankUpdateMatrix">[docs]</a><span class="k">class</span> <span class="nc">SquareLowRankUpdateMatrix</span><span class="p">(</span><span class="n">InvertibleMatrix</span><span class="p">,</span> <span class="n">ImplicitArrayMatrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Square matrix equal to a low-rank update to a square matrix.</span>

<span class="sd">    The matrix is assumed to have the parametrisation</span>

<span class="sd">        matrix = (</span>
<span class="sd">            square_matrix + sign * left_factor_matrix @ inner_square_matrix @</span>
<span class="sd">            right_factor_matrix)</span>

<span class="sd">    where `left_factor_matrix` and `right_factor_matrix` are rectangular with shapes</span>
<span class="sd">    `(dim_outer, dim_inner)` and `(dim_inner, dim_outer)` resp., `square_matrix` is</span>
<span class="sd">    square with shape `(dim_outer, dim_outer)`, `inner_square_matrix` is square with</span>
<span class="sd">    shape `(dim_inner, dim_inner)` and `sign` is one of {-1, +1} and determines whether</span>
<span class="sd">    a low-rank update (`sign = 1`) or &#39;downdate&#39; (`sign = -1`) is peformed.</span>

<span class="sd">    By exploiting the Woodbury matrix identity and matrix determinant lemma the inverse</span>
<span class="sd">    and determinant of the matrix can be computed at a cost of `O(dim_inner**3 +</span>
<span class="sd">    dim_inner**2 * dim_outer)` plus the cost of inverting / evaluating the determinant</span>
<span class="sd">    of `square_matrix`, which for `square_matrix` instances with special structure such</span>
<span class="sd">    as diagonality or with an existing factorisation, will typically be cheaper than the</span>
<span class="sd">    `O(dim_outer**3)` cost of evaluating the inverse or determinant directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">left_factor_matrix</span><span class="p">:</span> <span class="n">Matrix</span><span class="p">,</span>
        <span class="n">right_factor_matrix</span><span class="p">:</span> <span class="n">Matrix</span><span class="p">,</span>
        <span class="n">square_matrix</span><span class="p">:</span> <span class="n">SquareMatrix</span><span class="p">,</span>
        <span class="n">inner_square_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SquareMatrix</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">capacitance_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SquareMatrix</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sign</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            left_factor_matrix: Rectangular matrix with shape `(dim_outer, dim_inner)`</span>
<span class="sd">                forming leftmost term in matrix product defining low-rank update.</span>
<span class="sd">            right_factor_matrix: Rectangular matrix with shape `(dim_inner, dim_outer)`</span>
<span class="sd">                forming rightmost term in matrix product defining low-rank update.</span>
<span class="sd">            square_matrix: Square matrix to perform low-rank update (or downdate) to.</span>
<span class="sd">            inner_square_matrix: Optional square matrix with shape</span>
<span class="sd">                `(dim_inner, dim_inner)` specifying inner term in matrix product</span>
<span class="sd">                defining low-rank update. If `None` an identity matrix is used.</span>
<span class="sd">            capacitance_matrix: Square matrix equal to</span>

<span class="sd">                    inner_square_matrix.inv</span>
<span class="sd">                    + right_factor_matrix @ square_matrix.inv @ left_factor_matrix</span>

<span class="sd">                and with shape `(dim_inner, dim_inner)` which is used in constructing</span>
<span class="sd">                inverse and computation of determinant of the low-rank updated matrix,</span>
<span class="sd">                with this argument optional and typically only passed when this matrix</span>
<span class="sd">                has already been computed in a previous computation.</span>
<span class="sd">            sign: One of {-1, +1}, determining whether a low-rank update (`sign = 1`) or</span>
<span class="sd">                &#39;downdate&#39; (`sign = -1`) is peformed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim_outer</span><span class="p">,</span> <span class="n">dim_inner</span> <span class="o">=</span> <span class="n">left_factor_matrix</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">square_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dim_outer</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Inconsistent factor and square matrix shapes: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;outer dimensions </span><span class="si">{</span><span class="n">dim_outer</span><span class="si">}</span><span class="s2"> and &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">square_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">square_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">square_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;square_matrix argument must be square&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left_factor_matrix</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">):</span>
            <span class="n">left_factor_matrix</span> <span class="o">=</span> <span class="n">DenseRectangularMatrix</span><span class="p">(</span><span class="n">left_factor_matrix</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right_factor_matrix</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">):</span>
            <span class="n">right_factor_matrix</span> <span class="o">=</span> <span class="n">DenseRectangularMatrix</span><span class="p">(</span><span class="n">right_factor_matrix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">right_factor_matrix</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">dim_inner</span><span class="p">,</span> <span class="n">dim_outer</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Inconsistent factor matrix shapes: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left_factor_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">right_factor_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">inner_square_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inner_square_matrix</span> <span class="o">=</span> <span class="n">IdentityMatrix</span><span class="p">(</span><span class="n">dim_inner</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inner_square_matrix</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">dim_inner</span><span class="p">,</span> <span class="n">dim_inner</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;inner_square matrix must be square and of shape&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="p">(</span><span class="n">dim_inner</span><span class="p">,</span><span class="w"> </span><span class="n">dim_inner</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left_factor_matrix</span> <span class="o">=</span> <span class="n">left_factor_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_factor_matrix</span> <span class="o">=</span> <span class="n">right_factor_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span> <span class="o">=</span> <span class="n">square_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span> <span class="o">=</span> <span class="n">inner_square_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="o">=</span> <span class="n">capacitance_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span> <span class="o">=</span> <span class="n">sign</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">((</span><span class="n">dim_outer</span><span class="p">,</span> <span class="n">dim_outer</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_left_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span> <span class="o">@</span> <span class="n">other</span> <span class="o">+</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_factor_matrix</span>
            <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span> <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right_factor_matrix</span> <span class="o">@</span> <span class="n">other</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_right_matrix_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">other</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span>
            <span class="o">+</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">other</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_factor_matrix</span><span class="p">)</span>
                <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span>
            <span class="p">)</span>
            <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_factor_matrix</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left_factor_matrix</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right_factor_matrix</span><span class="p">,</span>
            <span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span><span class="p">,</span>
            <span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="o">/</span> <span class="n">scalar</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span><span class="o">.</span><span class="n">array</span> <span class="o">+</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_factor_matrix</span>
            <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_factor_matrix</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">capacitance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DenseSquareMatrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="o">=</span> <span class="n">DenseSquareMatrix</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">array</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_factor_matrix</span>
                <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_factor_matrix</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">diagonal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span><span class="o">.</span><span class="n">diagonal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span> <span class="o">*</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_factor_matrix</span><span class="o">.</span><span class="n">array</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span><span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_factor_matrix</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">array</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SquareLowRankUpdateMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right_factor_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left_factor_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SquareLowRankUpdateMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_factor_matrix</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right_factor_matrix</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span><span class="o">.</span><span class="n">inv</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span><span class="o">.</span><span class="n">inv</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capacitance_matrix</span><span class="o">.</span><span class="n">inv</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span><span class="o">.</span><span class="n">inv</span><span class="p">,</span>
            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span><span class="o">.</span><span class="n">log_abs_det</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span><span class="o">.</span><span class="n">log_abs_det</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacitance_matrix</span><span class="o">.</span><span class="n">log_abs_det</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">left_factor_matrix</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">right_factor_matrix</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">SquareLowRankUpdateMatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left_factor_matrix</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">left_factor_matrix</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_factor_matrix</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">right_factor_matrix</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">square_matrix</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">inner_square_matrix</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SymmetricLowRankUpdateMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.SymmetricLowRankUpdateMatrix">[docs]</a><span class="k">class</span> <span class="nc">SymmetricLowRankUpdateMatrix</span><span class="p">(</span>
    <span class="n">SquareLowRankUpdateMatrix</span><span class="p">,</span> <span class="n">SymmetricMatrix</span><span class="p">,</span> <span class="n">InvertibleMatrix</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Symmetric matrix equal to a low-rank update to a symmetric matrix.</span>

<span class="sd">    The matrix is assumed to have the parametrisation</span>

<span class="sd">        matrix = (</span>
<span class="sd">            symmetric_matrix + sign * factor_matrix @ inner_symmetric_matrix @</span>
<span class="sd">            factor_matrix.T)</span>

<span class="sd">    where `factor_matrix` is rectangular with shape `(dim_outer, dim_inner)`,</span>
<span class="sd">    `symmetric_matrix` is symmetric with shape `(dim_outer, dim_outer)`,</span>
<span class="sd">    `inner_symmetric_matrix` is symmetric with shape `(dim_inner, dim_inner)` and `sign`</span>
<span class="sd">    is one of {-1, +1} and determines whether a low-rank update (`sign = 1`) or</span>
<span class="sd">    &#39;downdate&#39; (`sign = -1`) is peformed.</span>

<span class="sd">    By exploiting the Woodbury matrix identity and matrix determinant lemma the inverse</span>
<span class="sd">    and determinant of the matrix can be computed at a cost of `O(dim_inner**3 +</span>
<span class="sd">    dim_inner**2 * dim_outer)` plus the cost of inverting / evaluating the determinant</span>
<span class="sd">    of `square_matrix`, which for `square_matrix` instances with special structure such</span>
<span class="sd">    as diagonality or with an existing factorisation, will typically be cheaper than the</span>
<span class="sd">    `O(dim_outer**3)` cost of evaluating the inverse or determinant directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">factor_matrix</span><span class="p">:</span> <span class="n">Matrix</span><span class="p">,</span>
        <span class="n">symmetric_matrix</span><span class="p">:</span> <span class="n">SymmetricMatrix</span><span class="p">,</span>
        <span class="n">inner_symmetric_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SymmetricMatrix</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">capacitance_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SymmetricMatrix</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sign</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            factor_matrix (Matrix): Rectangular matrix with shape</span>
<span class="sd">                `(dim_outer, dim_inner)` with it and its transpose forming the</span>
<span class="sd">                leftmost and righmost term respectively in the matrix product</span>
<span class="sd">                defining the low-rank update.</span>
<span class="sd">            symmetric_matrix: Symmetric matrix to perform low-rank update (or downdate)</span>
<span class="sd">                to.</span>
<span class="sd">            inner_symmetric_matrix: Optional symmetric matrix with shape</span>
<span class="sd">                `(dim_inner, dim_inner)` specifying inner term in matrix product</span>
<span class="sd">                defining low-rank update. If `None` an identity matrix is used.</span>
<span class="sd">            capacitance_matrix: Symmetric matrix  equal to</span>

<span class="sd">                    inner_symmetric_matrix.inv</span>
<span class="sd">                    + factor_matrix.T @  symmetric_matrix.inv @ factor_matrix</span>

<span class="sd">                and with shape `(dim_inner, dim_inner)` which is used in constructing</span>
<span class="sd">                inverse and computation of determinant of the low-rank updated matrix,</span>
<span class="sd">                with this argument optional and typically only passed when this matrix</span>
<span class="sd">                has already been computed in a previous computation.</span>
<span class="sd">            sign: One of {-1, +1}, determining whether a low-rank update (`sign = 1`) or</span>
<span class="sd">                &#39;downdate&#39; (`sign = -1`) is peformed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim_inner</span> <span class="o">=</span> <span class="n">factor_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">symmetric_matrix</span><span class="o">.</span><span class="n">T</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">symmetric_matrix</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;symmetric_matrix must be symmetric&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inner_symmetric_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inner_symmetric_matrix</span> <span class="o">=</span> <span class="n">IdentityMatrix</span><span class="p">(</span><span class="n">dim_inner</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inner_symmetric_matrix</span><span class="o">.</span><span class="n">T</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inner_symmetric_matrix</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;inner_symmetric_matrix must be symmetric&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">factor_matrix</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">):</span>
            <span class="n">factor_matrix</span> <span class="o">=</span> <span class="n">DenseRectangularMatrix</span><span class="p">(</span><span class="n">factor_matrix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span> <span class="o">=</span> <span class="n">factor_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetric_matrix</span> <span class="o">=</span> <span class="n">symmetric_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inner_symmetric_matrix</span> <span class="o">=</span> <span class="n">inner_symmetric_matrix</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">factor_matrix</span><span class="p">,</span>
            <span class="n">factor_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">symmetric_matrix</span><span class="p">,</span>
            <span class="n">inner_symmetric_matrix</span><span class="p">,</span>
            <span class="n">capacitance_matrix</span><span class="p">,</span>
            <span class="n">sign</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SymmetricLowRankUpdateMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span><span class="p">,</span>
            <span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetric_matrix</span><span class="p">,</span>
            <span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_symmetric_matrix</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="o">/</span> <span class="n">scalar</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">capacitance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DenseSymmetricMatrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="o">=</span> <span class="n">DenseSymmetricMatrix</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inner_symmetric_matrix</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">array</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span><span class="o">.</span><span class="n">T</span>
                <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetric_matrix</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span>

    <span class="k">def</span> <span class="nf">_construct_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SymmetricLowRankUpdateMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symmetric_matrix</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symmetric_matrix</span><span class="o">.</span><span class="n">inv</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capacitance_matrix</span><span class="o">.</span><span class="n">inv</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inner_symmetric_matrix</span><span class="o">.</span><span class="n">inv</span><span class="p">,</span>
            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SymmetricLowRankUpdateMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_compute_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">square_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_square_matrix</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_equality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">SymmetricLowRankUpdateMatrix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">factor_matrix</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetric_matrix</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">symmetric_matrix</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_symmetric_matrix</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">inner_symmetric_matrix</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PositiveDefiniteLowRankUpdateMatrix"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.PositiveDefiniteLowRankUpdateMatrix">[docs]</a><span class="k">class</span> <span class="nc">PositiveDefiniteLowRankUpdateMatrix</span><span class="p">(</span>
    <span class="n">SymmetricLowRankUpdateMatrix</span><span class="p">,</span> <span class="n">PositiveDefiniteMatrix</span><span class="p">,</span> <span class="n">DifferentiableMatrix</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Positive-definite matrix equal to low-rank update to a square matrix.</span>

<span class="sd">    The matrix is assumed to have the parametrisation</span>

<span class="sd">        matrix = (</span>
<span class="sd">            pos_def_matrix + sign * factor_matrix @ inner_pos_def_matrix @</span>
<span class="sd">            factor_matrix.T)</span>

<span class="sd">    where `factor_matrix` is rectangular with shape `(dim_outer, dim_inner)`,</span>
<span class="sd">    `pos_def_matrix` is positive-definite with shape `(dim_outer, dim_outer)`,</span>
<span class="sd">    `inner_pos_def_matrix` is positive-definite with shape `(dim_inner, dim_inner)` and</span>
<span class="sd">    `sign` is one of {-1, +1} and determines whether a low-rank update (`sign = 1`) or</span>
<span class="sd">    &#39;downdate&#39; (`sign = -1`) is peformed.</span>

<span class="sd">    By exploiting the Woodbury matrix identity and matrix determinant lemma the inverse,</span>
<span class="sd">    determinant and square-root of the matrix can all be computed at a cost of</span>
<span class="sd">    `O(dim_inner**3 + dim_inner**2 * dim_outer)` plus the cost of inverting / evaluating</span>
<span class="sd">    the determinant / square_root of `pos_def_matrix`, which for `pos_def_matrix`</span>
<span class="sd">    instances with special structure such as diagonality or with an existing</span>
<span class="sd">    factorisation, will typically be cheaper than the `O(dim_outer**3)` cost of</span>
<span class="sd">    evaluating the inverse, determinant or square-root directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">factor_matrix</span><span class="p">:</span> <span class="n">Matrix</span><span class="p">,</span>
        <span class="n">pos_def_matrix</span><span class="p">:</span> <span class="n">PositiveDefiniteMatrix</span><span class="p">,</span>
        <span class="n">inner_pos_def_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PositiveDefiniteMatrix</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">capacitance_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PositiveDefiniteMatrix</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sign</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            factor_matrix: Rectangular matrix with shape `(dim_outer, dim_inner)` with</span>
<span class="sd">                it and its transpose forming the leftmost and righmost term respectively</span>
<span class="sd">                in the matrix product defining the low-rank update.</span>
<span class="sd">            pos_def_matrix: Positive-definite matrix to perform low-rank update (or</span>
<span class="sd">                downdate) to.</span>
<span class="sd">            inner_pos_def_matrix: Optional positive definite matrix with shape</span>
<span class="sd">                `(dim_inner, dim_inner)` specifying inner term in matrix product</span>
<span class="sd">                defining low-rank update. If `None` an identity matrix is used.</span>
<span class="sd">            capacitance_matrix: Positive-definite matrix equal to</span>

<span class="sd">                    inner_pos_def_matrix.inv</span>
<span class="sd">                    + factor_matrix.T @ pos_def_matrix.inv @ factor_matrix</span>

<span class="sd">                and with shape `(dim_inner, dim_inner)` which is used in constructing</span>
<span class="sd">                inverse and computation of determinant of the low-rank updated matrix,</span>
<span class="sd">                with this argument optional and typically only passed when this matrix</span>
<span class="sd">                has already been computed in a previous computation.</span>
<span class="sd">            sign: One of {-1, +1}, determining whether a low-rank update (`sign = 1`) or</span>
<span class="sd">                &#39;downdate&#39; (`sign = -1`) is peformed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim_inner</span> <span class="o">=</span> <span class="n">factor_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">factor_matrix</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">):</span>
            <span class="n">factor_matrix</span> <span class="o">=</span> <span class="n">DenseRectangularMatrix</span><span class="p">(</span><span class="n">factor_matrix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span> <span class="o">=</span> <span class="n">factor_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_def_matrix</span> <span class="o">=</span> <span class="n">pos_def_matrix</span>
        <span class="k">if</span> <span class="n">inner_pos_def_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inner_pos_def_matrix</span> <span class="o">=</span> <span class="n">IdentityMatrix</span><span class="p">(</span><span class="n">dim_inner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inner_pos_def_matrix</span> <span class="o">=</span> <span class="n">inner_pos_def_matrix</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">factor_matrix</span><span class="p">,</span>
            <span class="n">pos_def_matrix</span><span class="p">,</span>
            <span class="n">inner_pos_def_matrix</span><span class="p">,</span>
            <span class="n">capacitance_matrix</span><span class="p">,</span>
            <span class="n">sign</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="n">ScalarLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SymmetricLowRankUpdateMatrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scalar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PositiveDefiniteLowRankUpdateMatrix</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span><span class="p">,</span>
                <span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_def_matrix</span><span class="p">,</span>
                <span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_pos_def_matrix</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="o">/</span> <span class="n">scalar</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SymmetricLowRankUpdateMatrix</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span><span class="p">,</span>
                <span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_def_matrix</span><span class="p">,</span>
                <span class="n">scalar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_pos_def_matrix</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="o">/</span> <span class="n">scalar</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">capacitance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DensePositiveDefiniteMatrix</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span> <span class="o">=</span> <span class="n">DensePositiveDefiniteMatrix</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inner_pos_def_matrix</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">array</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span><span class="o">.</span><span class="n">T</span>
                <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_def_matrix</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacitance_matrix</span>

    <span class="k">def</span> <span class="nf">_construct_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MatrixProduct</span><span class="p">:</span>
        <span class="c1"># Uses O(dim_inner**3 + dim_inner**2 * dim_outer) cost implementation proposed</span>
        <span class="c1"># in</span>
        <span class="c1">#   Ambikasaran, O&#39;Neill &amp; Singh (2016). Fast symmetric factorization</span>
        <span class="c1">#   of hierarchical matrices with applications. arxiv:1405.0223.</span>
        <span class="c1"># Variable naming below follows notation in Algorithm 1 in paper</span>
        <span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_def_matrix</span><span class="o">.</span><span class="n">sqrt</span>
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_pos_def_matrix</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">TriangularMatrix</span><span class="p">(</span>
            <span class="n">nla</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">U</span><span class="o">.</span><span class="n">array</span><span class="p">),</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">make_triangular</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">I_outer</span><span class="p">,</span> <span class="n">I_inner</span> <span class="o">=</span> <span class="n">IdentityMatrix</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">sla</span><span class="o">.</span><span class="n">sqrtm</span><span class="p">(</span><span class="n">I_inner</span> <span class="o">+</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">K</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">array</span><span class="p">))</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">DenseSymmetricMatrix</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">((</span><span class="n">M</span> <span class="o">-</span> <span class="n">I_inner</span><span class="p">)</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">inv</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">W</span> <span class="o">@</span> <span class="n">SymmetricLowRankUpdateMatrix</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">I_outer</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grad_log_abs_det</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span><span class="o">.</span><span class="n">array</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_pos_def_matrix</span><span class="p">))</span>

<div class="viewcode-block" id="PositiveDefiniteLowRankUpdateMatrix.grad_quadratic_form_inv"><a class="viewcode-back" href="../../mici.matrices.html#mici.matrices.PositiveDefiniteLowRankUpdateMatrix.grad_quadratic_form_inv">[docs]</a>    <span class="k">def</span> <span class="nf">grad_quadratic_form_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="n">inv_matrix_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv</span> <span class="o">@</span> <span class="n">vector</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span>
            <span class="n">inv_matrix_vector</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inner_pos_def_matrix</span> <span class="o">@</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factor_matrix</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">inv_matrix_vector</span><span class="p">),</span>
        <span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Matt Graham.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>